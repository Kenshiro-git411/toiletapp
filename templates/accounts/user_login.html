{% extends 'accounts/base.html' %}
{% load static %}

{% block title %} ログイン画面 {% endblock %}

{% block content %}
    <div class="items-center justify-center">
        <!-- タイトルを中央ぞろえ -->
        <h1 class="text-2xl font-bold w-3/5 mx-auto text-center my-5 sm:my-10">ログイン</h1>
        <div class="flex flex-col items-center justify-center rounded-lg py-2">
            <form method="post" action="" class="w-full sm:w-3/5 ">{% csrf_token %}
                <div class="mt-7">
                    <label class="font-bold">{{ login_form.email.label }}</label>
                    <div>{{ login_form.email }}</div>
                </div>
                <div class="mt-5">
                    <label class="font-bold">{{ login_form.password.label }}</label>
                    <div>{{ login_form.password }}</div>
                </div>
                <button type="submit" class="w-3/5 flex items-center justify-center w-full bg-[#62AEE4] hover:bg-[#40A0E3] border-transparent mt-10 py-2 shadow-lg text-white font-bold hover:shadow-none hover:duration-400">ログイン</button>
            </form>
            <button id="line_login" class="flex items-center justify-center mt-10 w-full sm:w-3/5 mx-auto text-center bg-[#06C755] p-2"><img src="{% static '/accounts/account_line_login.png' %}" alt="LINEログイン" class="h-6"><span class="px-4 text-white font-bold">LINEでログイン</span></button>
            <div class="flex items-center justify-center my-10 pb-10 w-full sm:w-3/5 border-b border-gray-400">
                <a href="{% url 'accounts:password_reset_request' %}" class=" mx-auto text-center border-b border-gray-400">パスワードお忘れの方はこちら</a>
            </div>
            <a href="{% url 'accounts:user_create' %}" class="mx-auto text-center text-[#40A0E3] font-bold bg-white my-5 py-2 w-full sm:w-3/5 outline outline-3 outline-bg-[#40A0E3] shadow-lg hover:shadow-none hover:duration-700">ユーザー登録</a>
        </div>
    </div>
    <p>LIFF ID: {{ liff_id }}</p>
    <!-- CSRFトークンを隠しフィールドとして追加 -->
    <form id="csrf-form" style="display: none;">
        {% csrf_token %}
    </form>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
    <script>
        const LIFF_ID = "{{ liff_id|escapejs }}";
        document.addEventListener("DOMContentLoaded", function(){
            // ライン公式の認証がされているかどうか
            {% if not user.is_authenticated %}
            liff.init({
                liffId: LIFF_ID
            })
            .then(() => {
                if (liff.isLoggedIn()){
                    liff.getProfile().then(profile => {
                        console.log("django内ログイン認証");
                        const csrfToken = "{{ csrf_token }}";
                            // django内ユーザー認証処理
                            fetch("{% url 'accounts:liff_login' %}", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken
                                },
                                credentials: 'same-origin',
                                body: JSON.stringify({
                                    line_id: profile.userId,
                                    line_name: profile.displayName
                                })
                            }).then(response => response.json())
                            .then(data => {
                                if(data.success && data.redirect_url){
                                    window.location.href = data.redirect_url;
                                } else {
                                    alert("ログイン失敗:" + data.message);
                                }
                            }).catch(err => {
                                console.error('送信エラー:', err);
                            });
                    });
                }
            }).catch(err => {
                console.error("LIFF初期化エラー", err);
            })
            {% endif %}


            // ラインでログインボタンを押されたときの処理
            document.getElementById('line_login').addEventListener('click', () => {
                console.log("userはLINE公式未認証です。認証を行います。")
                // ライン公式の認証がされているかどうか
                if (!liff.isLoggedIn()){
                    // ライン公式の認証処理 -> リダイレクトで再度本画面に遷移する
                    liff.login({
                        redirectUri: "https://605c-106-72-36-161.ngrok-free.app/accounts/user_login/"
                    });
                }
            });
        });

    </script>
{% endblock %}